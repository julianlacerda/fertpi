<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lei de Stokes â€” SedimentaÃ§Ã£o (T, saÃ­da numÃ©rica hh:mm:ss, tema claro/escuro)</title>
<style>
  /* ===== Paletas (variÃ¡veis) ===== */
  :root{
    --bg:#0b1020; --panel:#0e162a; --muted:#9fb2cc; --text:#e7eefc; --accent:#22d3ee;
    --good:#22a86b; --warn:#b57c09; --bad:#c64f4f; --line:#1f2a44; --glass:#0c1323;
    --field-bg:#0b1428; --field-bd:#20365f; --btn-bd:#223e72; --tick:#9cc7ff;
  }
  :root[data-theme="light"]{
    --bg:#ffffff; --panel:#f7f9fc; --muted:#5a6b82; --text:#0e1726; --accent:#0ea5e9;
    --good:#15803d; --warn:#b45309; --bad:#b91c1c; --line:#d3dfef; --glass:#eaf2ff;
    --field-bg:#ffffff; --field-bd:#cdd9ea; --btn-bd:#c3d3ea; --tick:#244b74;
  }

  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
    background: var(--bg);
    background-image:
      radial-gradient(1400px 700px at 15% -10%, rgba(20,42,82,0.9) 0%, rgba(10,17,31,0) 60%),
      radial-gradient(1100px 600px at 85% 110%, rgba(15,36,72,0.9) 0%, rgba(10,17,31,0) 60%);
    background-blend-mode: multiply;
  }
  :root[data-theme="light"] body, :root[data-theme="light"]{
    background: var(--bg);
    background-image: none;
  }

  header{
    padding:16px 20px; position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,rgba(10,15,31,.85),rgba(10,15,31,.55));
    border-bottom:1px solid #162443; backdrop-filter: blur(6px);
  }
  :root[data-theme="light"] header{
    background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7));
    border-bottom:1px solid var(--line);
    backdrop-filter: blur(6px);
  }

  h1{margin:0 0 4px; font-size:clamp(18px,2.2vw,28px)}
  .sub{color:var(--muted); font-size:13px}
  main{display:grid; grid-template-columns:460px 1fr; gap:16px; padding:16px}
  @media (max-width:1100px){ main{grid-template-columns:1fr} }

  .panel{
    background:
      linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.0)),
      linear-gradient(180deg,var(--panel),var(--panel));
    border:1px solid var(--line); border-radius:16px; padding:14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.10), inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .group{margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed var(--line)}
  .group:last-child{border-bottom:none; margin-bottom:0}
  .row{display:grid; grid-template-columns:1fr 170px; gap:8px; align-items:center; margin:8px 0}
  .row label{font-size:13px; color:var(--text)}
  .row input[type="number"], .row select{
    width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--field-bd);
    background:var(--field-bg); color:var(--text);
  }
  .row input[type="range"]{width:100%}
  .tiny{font-size:12px; color:var(--muted)}
  .btnbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  button{
    background:linear-gradient(180deg,#15223b,#0f1a30); color:#e7eefc;
    border:1px solid var(--btn-bd); padding:9px 12px; border-radius:12px; cursor:pointer
  }
  button:hover{border-color:#3a66af}
  :root[data-theme="light"] button{
    background:linear-gradient(180deg,#f3f7ff,#eaf1ff); color:#0e1726; border-color:#c9d8ef;
  }
  .btn-accent{border-color:#06b6d4; box-shadow:0 0 0 1px rgba(34,211,238,.25) inset}
  .btn-danger{border-color:#ef4444; color:#ffe4e6}
  :root[data-theme="light"] .btn-danger{color:#7f1d1d}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px;
        background:var(--field-bg); border:1px solid var(--field-bd); font-size:12px}
  .badge{display:inline-block; padding:2px 8px; border:1px solid var(--field-bd); border-radius:999px; background:var(--field-bg); font-size:12px}
  .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .legend .item{display:flex; gap:6px; align-items:center; font-size:12px; color:var(--text)}
  .dot{width:10px; height:10px; border-radius:50%}
  .kv{display:grid; grid-template-columns:1fr auto; gap:6px; font-size:13px}
  .kv div{padding:2px 0; border-bottom:1px dotted var(--line)}
  .kv div:last-child{border-bottom:none}
  details summary{cursor:pointer; color:var(--accent)}
  code{background:var(--field-bg); padding:2px 6px; border:1px solid var(--field-bd); border-radius:6px}

  /* Canvas visual */
  .visualWrap{position:relative}
  canvas#view{width:100%; height:620px; display:block; background:transparent}
  .tankTitle{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
  .meter{height:8px;border-radius:6px;background:var(--field-bg);border:1px solid var(--field-bd);overflow:hidden}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,#34d399,#f59e0b,#f87171);width:0%}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
</style>
</head>
<body>
<header>
  <h1>Lei de Stokes â€” Simulador (coluna 3D + T + saÃ­da numÃ©rica hh:mm:ss)</h1>
  <div class="sub">v = Ï† Â· ((Ï<sub>p</sub> âˆ’ Ï<sub>f</sub>)Â·gÂ·dÂ²)/(18Â·Î¼) &nbsp;|&nbsp; vÃ¡lido para Re &lt; 0,1</div>
</header>

<main>
  <!-- CONTROLES -->
  <section class="panel" id="controls">
    <div class="group">
      <div class="row">
        <label>Tema</label>
        <select id="themeSelect">
          <option value="dark" selected>Escuro</option>
          <option value="light">Branco</option>
        </select>
      </div>
      <div class="row">
        <label>PrÃ©-set de fluido</label>
        <select id="fluidPreset">
          <option value="water_auto" selected>Ãgua (auto por T)</option>
          <option value="water_manual">Ãgua (manual)</option>
          <option value="veg_oil">Ã“leo vegetal (~20 Â°C)</option>
          <option value="glycerin">Glicerina 99% (~20 Â°C)</option>
          <option value="air">Ar (~20 Â°C)</option>
        </select>
      </div>
      <div class="row">
        <label>Usar correÃ§Ã£o de T (Ã¡gua)</label>
        <select id="useWaterT">
          <option value="on" selected>Sim</option>
          <option value="off">NÃ£o</option>
        </select>
      </div>
      <div class="row">
        <label>Temperatura [Â°C] (Ã¡gua)</label>
        <input type="number" id="T" step="0.1" value="20.0" min="0" max="100" />
      </div>
      <div class="row"><label>Ï<sub>f</sub> fluido [kgÂ·mâ»Â³]</label><input type="number" id="rho_f" step="0.1" value="997.0" min="0.1" max="5000" /></div>
      <div class="row"><label>Î¼ fluido [mPaÂ·s]</label><input type="number" id="mu_mpas" step="0.001" value="1.000" min="0.001" max="50000" /></div>
      <div class="row"><label>g [mÂ·sâ»Â²]</label><input type="number" id="g" step="0.01" value="9.81" min="0.1" max="50" /></div>
      <div class="row"><label>Altura da coluna [cm]</label><input type="number" id="H_cm" step="1" value="50" min="5" max="500" /></div>
      <div class="row"><label>AceleraÃ§Ã£o do tempo</label><input type="range" id="timeScale" min="1" max="400" value="60" /></div>
      <div class="tiny">â€œÃgua (auto por T)â€ atualiza Ï<sub>f</sub> e Î¼ automaticamente a partir da temperatura.</div>
    </div>

    <div class="group">
      <strong>PartÃ­culas â€” adicionar lote</strong>
      <div class="row"><label>Ï<sub>p</sub> [kgÂ·mâ»Â³]</label><input type="number" id="rho_p" step="1" value="2650" min="200" max="10000"/></div>
      <div class="row"><label>d mÃ©dio [Î¼m]</label><input type="number" id="d_um" step="0.1" value="100" min="0.01" max="20000"/></div>
      <div class="row"><label>Â± variaÃ§Ã£o (% d)</label><input type="number" id="d_spread" step="1" value="10" min="0" max="100"/></div>
      <div class="row"><label>Esfericidade Ï† (0â€“1)</label><input type="number" id="phi" step="0.01" value="1.00" min="0.10" max="1.00"/></div>
      <div class="row"><label>Quantidade</label><input type="number" id="n_particles" step="1" value="100" min="1" max="5000"/></div>
      <div class="btnbar">
        <button id="addBatch" class="btn-accent">Adicionar lote</button>
        <button id="clearBatches" class="btn-danger">Limpar partÃ­culas</button>
      </div>
      <div class="legend" id="legend"></div>
    </div>

    <div class="group">
      <strong>SimulaÃ§Ã£o</strong>
      <div class="btnbar">
        <button id="playPause">â¸ï¸ Pausar</button>
        <button id="reset">ğŸ” Reset</button>
        <button id="exportCsv">â¬‡ï¸ CSV partÃ­culas</button>
      </div>
      <div class="kv" style="margin-top:8px">
        <div>Vel. terminal (selecionada)</div><div><span id="vTerm">â€”</span> mÂ·sâ»Â¹</div>
        <div>Reynolds (selecionada)</div><div id="reynolds" class="pill">â€”</div>
        <div>T<sub>alvo</sub> (atÃ© fundo/superfÃ­cie)</div><div><span id="tSettle">â€”</span> s</div>
        <div>Regime</div><div id="regime" class="pill">â€”</div>
      </div>
      <div class="meter" style="margin-top:8px"><span id="reMeter"></span></div>
      <div class="tiny">Verde â‰ˆ Re &lt; 0,1 (Stokes); Ã‚mbar: transiÃ§Ã£o; Vermelho: fora.</div>
    </div>

    <details>
      <summary>Teoria (resumo)</summary>
      <p><code>v = Ï† Â· ((Ïp âˆ’ Ïf) Â· g Â· dÂ²)/(18 Â· Î¼)</code>, <code>Re = (Ïf Â· |v| Â· d)/Î¼</code>. Lei de Stokes indicada para <strong>Re &lt; 0,1</strong>.</p>
      <p>Ãgua(T): Î¼(PaÂ·s) â‰ˆ 2,414Ã—10â»âµÂ·10^(247,8/(T+133,15)); Ï(kgÂ·mâ»Â³) â‰ˆ fÃ³rmula de Kell (0â€“100 Â°C).</p>
    </details>
  </section>

  <!-- VISUAL 3D -->
  <section class="panel">
    <div class="tankTitle">
      <strong>Coluna de sedimentaÃ§Ã£o (visual 3D)</strong>
      <span class="pill">PartÃ­culas: <span id="countLabel">0</span></span>
    </div>
    <div class="visualWrap">
      <canvas id="view" width="1000" height="620"></canvas>
    </div>
  </section>

  <!-- SAÃDA NUMÃ‰RICA -->
  <section class="panel">
    <div class="btnbar" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong>SaÃ­da numÃ©rica (Lei de Stokes) â€” tempo em funÃ§Ã£o dos parÃ¢metros</strong>
      <span class="badge">t = h / |v|, &nbsp; v = Ï†Â·((Ïpâˆ’Ïf)Â·gÂ·dÂ²)/(18Â·Î¼)</span>
    </div>

    <div class="row"><label>Altura a percorrer, h [cm]</label><input type="number" id="h_target_cm" step="0.1" value="50" min="0.01" /></div>
    <div class="row"><label>DiÃ¢metro d [Î¼m]</label><input type="number" id="calc_d_um" step="0.01" value="100" min="0.001" /></div>
    <div class="row"><label>Esfericidade Ï†</label><input type="number" id="calc_phi" step="0.01" value="1.00" min="0.10" max="1.00" /></div>
    <div class="row"><label>Ï<sub>p</sub> [kgÂ·mâ»Â³]</label><input type="number" id="calc_rho_p" step="0.1" value="2650" /></div>

    <div class="row"><label>Usar T(Ã¡gua) p/ Ï<sub>f</sub> e Î¼</label>
      <select id="calc_useWaterT">
        <option value="on">Sim</option>
        <option value="off" selected>NÃ£o</option>
      </select>
    </div>
    <div class="row"><label>Temperatura [Â°C] (Ã¡gua)</label><input type="number" id="calc_T" step="0.1" value="20.0" min="0" max="100" /></div>

    <div class="row"><label>Ï<sub>f</sub> [kgÂ·mâ»Â³]</label><input type="number" id="calc_rho_f" step="0.1" value="997.0" /></div>
    <div class="row"><label>Î¼ [mPaÂ·s]</label><input type="number" id="calc_mu_mpas" step="0.001" value="1.000" /></div>
    <div class="row"><label>g [mÂ·sâ»Â²]</label><input type="number" id="calc_g" step="0.01" value="9.81" /></div>

    <div class="btnbar">
      <button id="calcSyncFromTop">Usar valores atuais do painel</button>
      <button id="calcNow" class="btn-accent">Calcular</button>
      <button id="calcCopy">Copiar resultados</button>
      <button id="calcCsv">â¬‡ï¸ CSV (1 linha)</button>
    </div>

    <div class="kv" style="margin-top:10px; grid-template-columns:repeat(2,1fr)">
      <div>Velocidade terminal v [mÂ·sâ»Â¹]</div><div id="out_v" class="pill">â€”</div>
      <div>NÃºmero de Reynolds Re [â€“]</div><div id="out_Re" class="pill">â€”</div>
      <div>Tempo t [s]</div><div id="out_t" class="pill">â€”</div>
      <div>Tempo t [min]</div><div id="out_t_min" class="pill">â€”</div>
      <div>Tempo t [hh:mm:ss]</div><div id="out_t_hms" class="pill">â€”</div>
      <div>DireÃ§Ã£o</div><div id="out_dir" class="pill">â€”</div>
      <div>Regime</div><div id="out_regime" class="pill">â€”</div>
      <div>T usada [Â°C]</div><div id="out_T" class="pill">â€”</div>
    </div>
    <div class="tiny" style="margin-top:8px">
      ObservaÃ§Ã£o: a validade da expressÃ£o de Stokes Ã© tÃ­pica para Re &lt; 0,1. Se Re â‰¥ 0,1, considere que o resultado Ã© uma aproximaÃ§Ã£o.
    </div>
  </section>
</main>

<script>
/* ===== UtilitÃ¡rios ===== */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const randNorm=(m,s)=>{let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();
  return m+s*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v)};
const fmt=(n,d=3)=>(isFinite(n)?n.toFixed(d):"â€”");
const pad2=n=>String(n).padStart(2,'0');
function toHMS(t_s){
  if(!isFinite(t_s)) return "â€”";
  const s = Math.max(0, Math.floor(t_s+1e-9));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
}

/* ===== Tema (light/dark) ===== */
const root = document.documentElement;
const themeSelect = () => document.getElementById('themeSelect');
function applyTheme(t){
  root.setAttribute('data-theme', t==="light" ? "light" : "dark");
  localStorage.setItem("stokes_theme", t);
}
function initTheme(){
  const saved = localStorage.getItem("stokes_theme") || "dark";
  applyTheme(saved);
  const sel = themeSelect();
  if(sel){ sel.value = saved; sel.addEventListener('change', ()=>applyTheme(sel.value)); }
}

/* ===== Estado ===== */
const state={
  fluid:{rho_f:997,mu_mpas:1.0,g:9.81,H_cm:50,T:20,useWaterT:true,preset:"water_auto"},
  timeScale:60,playing:true,
  particles:[],batches:[],selected:null,tSim:0,
  csvRows:[["batch_id","id","d_um","phi","rho_p","rho_f","mu_Pa_s","g","v_ms","Re","t_target_s","direction"]]
};

/* ===== Elementos ===== */
const el={
  fluidPreset:document.getElementById('fluidPreset'),
  useWaterT:document.getElementById('useWaterT'),
  T:document.getElementById('T'),
  rho_f:document.getElementById('rho_f'),
  mu_mpas:document.getElementById('mu_mpas'),
  g:document.getElementById('g'),
  H_cm:document.getElementById('H_cm'),
  timeScale:document.getElementById('timeScale'),
  rho_p:document.getElementById('rho_p'),
  d_um:document.getElementById('d_um'),
  d_spread:document.getElementById('d_spread'),
  phi:document.getElementById('phi'),
  n_particles:document.getElementById('n_particles'),
  addBatch:document.getElementById('addBatch'),
  clearBatches:document.getElementById('clearBatches'),
  legend:document.getElementById('legend'),
  playPause:document.getElementById('playPause'),
  reset:document.getElementById('reset'),
  exportCsv:document.getElementById('exportCsv'),
  vTerm:document.getElementById('vTerm'),
  reynolds:document.getElementById('reynolds'),
  tSettle:document.getElementById('tSettle'),
  regime:document.getElementById('regime'),
  reMeter:document.getElementById('reMeter'),
  countLabel:document.getElementById('countLabel'),
  canvas:document.getElementById('view'),
  ctx:document.getElementById('view').getContext('2d'),

  // SaÃ­da numÃ©rica
  h_target_cm:document.getElementById('h_target_cm'),
  calc_d_um:document.getElementById('calc_d_um'),
  calc_phi:document.getElementById('calc_phi'),
  calc_rho_p:document.getElementById('calc_rho_p'),
  calc_useWaterT:document.getElementById('calc_useWaterT'),
  calc_T:document.getElementById('calc_T'),
  calc_rho_f:document.getElementById('calc_rho_f'),
  calc_mu_mpas:document.getElementById('calc_mu_mpas'),
  calc_g:document.getElementById('calc_g'),
  calcSyncFromTop:document.getElementById('calcSyncFromTop'),
  calcNow:document.getElementById('calcNow'),
  calcCopy:document.getElementById('calcCopy'),
  calcCsv:document.getElementById('calcCsv'),
  out_v:document.getElementById('out_v'),
  out_Re:document.getElementById('out_Re'),
  out_t:document.getElementById('out_t'),
  out_t_min:document.getElementById('out_t_min'),
  out_t_hms:document.getElementById('out_t_hms'),
  out_dir:document.getElementById('out_dir'),
  out_regime:document.getElementById('out_regime'),
  out_T:document.getElementById('out_T')
};

/* ===== Ãgua por T ===== */
function waterMuPaS_fromT(Tc){return 2.414e-5*Math.pow(10,247.8/(Tc+133.15));}
function waterRho_fromT(Tc){const t=Tc;return 1000*(1-((t+288.9414)/(508929.2*(t+68.12963)))*Math.pow(t-3.9863,2));}

/* ===== FÃ­sica ===== */
const muPaS=()=>Math.max(1e-6,parseFloat(el.mu_mpas.value||"1")*1e-3);
const dMeters=(d_um)=>parseFloat(d_um)*1e-6;
function vStokes_sphericity(d_m,rho_p,rho_f,mu,g,phi){return phi*((rho_p-rho_f)*g*d_m*d_m)/(18*mu);}
function reynolds(rho_f,vabs,d_m,mu){return (rho_f*vabs*d_m)/mu;}

/* ===== PrÃ©-sets ===== */
function applyPreset(){
  const p=el.fluidPreset.value; state.fluid.preset=p;
  const enableWaterT=(p==="water_auto");
  el.useWaterT.disabled=!enableWaterT; el.T.disabled=!enableWaterT;
  if(p==="water_auto"){
    el.useWaterT.value="on"; state.fluid.useWaterT=true; applyWaterT();
  }else if(p==="water_manual"){
    state.fluid.useWaterT=false; el.useWaterT.value="off";
    el.rho_f.value="997.0"; el.mu_mpas.value="1.000";
  }else if(p==="veg_oil"){
    state.fluid.useWaterT=false; el.useWaterT.value="off";
    el.rho_f.value="920.0"; el.mu_mpas.value="60.000";
  }else if(p==="glycerin"){
    state.fluid.useWaterT=false; el.useWaterT.value="off";
    el.rho_f.value="1260.0"; el.mu_mpas.value="945.000";
  }else if(p==="air"){
    state.fluid.useWaterT=false; el.useWaterT.value="off";
    el.rho_f.value="1.204"; el.mu_mpas.value="0.0181";
  }
  syncFluidFromUI();
  syncCalcFromTop();
}
el.fluidPreset.addEventListener('change', applyPreset);

/* ===== SincronizaÃ§Ã£o ===== */
function applyWaterT(){
  if(state.fluid.useWaterT){
    const Tc=parseFloat(el.T.value||"20");
    el.rho_f.value=waterRho_fromT(Tc).toFixed(1);
    el.mu_mpas.value=(waterMuPaS_fromT(Tc)*1e3).toFixed(3);
  }
}
function syncFluidFromUI(){
  state.fluid.useWaterT=(el.useWaterT.value==="on");
  state.fluid.T=parseFloat(el.T.value||"20");
  if(state.fluid.useWaterT && state.fluid.preset==="water_auto") applyWaterT();
  state.fluid.rho_f=parseFloat(el.rho_f.value||"997");
  state.fluid.g=parseFloat(el.g.value||"9.81");
  state.fluid.H_cm=parseFloat(el.H_cm.value||"50");
  state.fluid.mu_mpas=parseFloat(el.mu_mpas.value||"1");
  state.timeScale=parseInt(el.timeScale.value,10);
  if(state.selected!=null) updateSelectedIndicators();
}
['useWaterT','T','rho_f','mu_mpas','g','H_cm','timeScale'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{ syncFluidFromUI(); });
});

/* ===== Lotes ===== */
function colorForBatch(i,total){const h=(i*360/Math.max(1,total))%360;return `hsl(${h},80%,60%)`;}
function rebuildLegend(){
  const legend=document.getElementById('legend'); legend.innerHTML="";
  if(!state.batches.length){legend.textContent="Nenhum lote adicionado.";return;}
  state.batches.forEach(b=>{
    const it=document.createElement('div');it.className="item";
    const dot=document.createElement('span');dot.className="dot";dot.style.background=b.color;
    const tx=document.createElement('span');
    tx.innerHTML=`Lote ${b.id}: dâ‰ˆ${b.d_um.toFixed(1)} Î¼m, Ï†=${b.phi.toFixed(2)}, Ï<sub>p</sub>=${b.rho_p} kgÂ·mâ»Â³ (${b.n})`;
    it.appendChild(dot);it.appendChild(tx);legend.appendChild(it);
  });
}
function addBatch(){
  const rho_p=parseFloat(el.rho_p.value||"2650");
  const d_um=parseFloat(el.d_um.value||"100");
  const spread=Math.max(0,parseFloat(el.d_spread.value||"10"));
  const phi=clamp(parseFloat(el.phi.value||"1"),0.1,1);
  const n=clamp(parseInt(el.n_particles.value||"100",10),1,5000);
  const batchId=state.batches.length+1;
  const color=colorForBatch(batchId-1,Math.max(6,batchId+2));
  const Hm = state.fluid.H_cm/100;
  const mu = muPaS();

  state.batches.push({id:batchId,rho_p,d_um,spread,n,phi,color});

  for(let i=0;i<n;i++){
    const di=Math.max(0.01,randNorm(d_um,d_um*(spread/100)/2));
    const d_m=di*1e-6;
    const v=vStokes_sphericity(d_m,rho_p,state.fluid.rho_f,mu,state.fluid.g,phi);
    const Re=reynolds(state.fluid.rho_f,Math.abs(v),d_m,mu);
    const direction=v>=0?"descida":"subida";
    const t_target=(Hm)/Math.max(1e-12,Math.abs(v));

    const z = Math.random();
    const x = 40 + Math.random()*(el.canvas.width-80) + (z-0.5)*8;

    state.particles.push({
      batchId,id:i+1,x,z,
      d_m,d_um:di,rho_p,phi,color,v,Re,settled:false,depth_m:(v>=0?0:Hm),t0:state.tSim,t_target,direction
    });
    state.csvRows.push([batchId,i+1,di,phi,rho_p,state.fluid.rho_f,mu,state.fluid.g,v,Re,t_target,direction]);
  }
  rebuildLegend();
  el.countLabel.textContent=state.particles.length;
}
function clearBatches(){
  state.particles.length=0;state.batches.length=0;
  state.csvRows=[["batch_id","id","d_um","phi","rho_p","rho_f","mu_Pa_s","g","v_ms","Re","t_target_s","direction"]];
  rebuildLegend();el.countLabel.textContent=0;state.selected=null;updateSelectedIndicators(true);
}
el.addBatch.addEventListener('click',addBatch);
el.clearBatches.addEventListener('click',clearBatches);

/* ===== Indicadores ===== */
function updateSelectedIndicators(clear=false){
  if(clear||state.selected==null){
    el.vTerm.textContent="â€”";el.reynolds.textContent="â€”";el.tSettle.textContent="â€”";
    el.reynolds.className="pill";el.regime.className="pill";el.reMeter.style.width="0%";el.regime.textContent="â€”";return;
  }
  const p=state.particles[state.selected];const mu=muPaS();
  const v=vStokes_sphericity(p.d_m,p.rho_p,state.fluid.rho_f,mu,state.fluid.g,p.phi);
  const Re=reynolds(state.fluid.rho_f,Math.abs(v),p.d_m,mu);
  p.v=v;p.Re=Re;const Hm=state.fluid.H_cm/100;p.t_target=Hm/Math.max(1e-12,Math.abs(v));
  el.vTerm.textContent=fmt(v,5);el.tSettle.textContent=fmt(p.t_target,2);el.reynolds.textContent=fmt(Re,3);
  const cls = Re<0.1 ? "good" : (Re<1 ? "warn" : "bad");
  el.reynolds.className = "pill "+cls; el.regime.className="pill "+cls;
  el.regime.textContent = Re<0.1 ? "Stokes (laminar)" : (Re<1 ? "TransiÃ§Ã£o inicial" : "Fora de Stokes");
  el.reMeter.style.width=(Math.max(0,Math.min(200,Re))/2)+"%";
}

/* ===== RenderizaÃ§Ã£o da coluna com efeito 3D ===== */
function pxPerMeter(){const top=26,bottom=56;const usable=el.canvas.height-top-bottom;const Hm=state.fluid.H_cm/100;return usable/Math.max(Hm,1e-6)}
function yFromDepth(depth_m){const top=26;return top+depth_m*pxPerMeter();}

function drawTank(ctx,W,H){
  const isLight = document.documentElement.getAttribute('data-theme')==="light";
  const margin=36, top=20, bottom=40, left=margin, right=W-margin;
  const r=22;
  ctx.save();

  // Vidro do tanque
  const grd = ctx.createLinearGradient(0, top, 0, H-bottom);
  grd.addColorStop(0, isLight? "#f0f6ff" : "#0e1a33");
  grd.addColorStop(1, isLight? "#e6f0ff" : "#091226");
  ctx.fillStyle=grd;
  ctx.strokeStyle=isLight? "#c7d7ef" : "#1e335a";
  ctx.lineWidth=2.2;
  const width=right-left, height=H-top-bottom;
  ctx.beginPath();
  ctx.moveTo(left+r, top);
  ctx.lineTo(right-r, top); ctx.quadraticCurveTo(right, top, right, top+r);
  ctx.lineTo(right, top+height-r); ctx.quadraticCurveTo(right, top+height, right-r, top+height);
  ctx.lineTo(left+r, top+height); ctx.quadraticCurveTo(left, top+height, left, top+height-r);
  ctx.lineTo(left, top+r); ctx.quadraticCurveTo(left, top, left+r, top);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // SuperfÃ­cie do lÃ­quido
  const yTop = yFromDepth(0);
  ctx.beginPath();
  ctx.ellipse(W/2, yTop, width*0.48, 12, 0, 0, Math.PI*2);
  const surf=ctx.createRadialGradient(W*0.45, yTop-2, 6, W/2, yTop, width*0.5);
  if(isLight){
    surf.addColorStop(0,"rgba(180,210,255,0.6)");
    surf.addColorStop(0.3,"rgba(120,170,240,0.18)");
    surf.addColorStop(1,"rgba(120,170,240,0.06)");
  }else{
    surf.addColorStop(0,"rgba(180,225,255,0.55)");
    surf.addColorStop(0.3,"rgba(100,180,255,0.18)");
    surf.addColorStop(1,"rgba(60,120,220,0.08)");
  }
  ctx.fillStyle=surf; ctx.fill();

  // Reflexos verticais
  const refl=ctx.createLinearGradient(left, top, right, top);
  if(isLight){
    refl.addColorStop(0,"rgba(255,255,255,0.55)");
    refl.addColorStop(0.08,"rgba(255,255,255,0.18)");
    refl.addColorStop(0.12,"rgba(255,255,255,0.07)");
    refl.addColorStop(0.88,"rgba(255,255,255,0.04)");
    refl.addColorStop(1,"rgba(255,255,255,0.35)");
  }else{
    refl.addColorStop(0,"rgba(255,255,255,0.04)");
    refl.addColorStop(0.08,"rgba(255,255,255,0.18)");
    refl.addColorStop(0.12,"rgba(255,255,255,0.05)");
    refl.addColorStop(0.88,"rgba(255,255,255,0.02)");
    refl.addColorStop(1,"rgba(255,255,255,0.06)");
  }
  ctx.globalCompositeOperation="lighter";
  ctx.fillStyle=refl; ctx.fillRect(left+8, top+8, 18, height-16);
  ctx.fillRect(right-28, top+10, 14, height-20);
  ctx.globalCompositeOperation="source-over";

  // MarcaÃ§Ãµes
  ctx.strokeStyle=isLight? "rgba(60,90,130,0.1)" : "rgba(146,208,255,0.08)";
  ctx.lineWidth=1;
  const H_cm=state.fluid.H_cm, step=H_cm<=60?5:10;
  ctx.font="12px system-ui"; ctx.fillStyle=getTickColor();
  for(let c=0;c<=H_cm;c+=step){
    const y=yFromDepth(c/100);
    ctx.beginPath(); ctx.moveTo(left-6,y); ctx.lineTo(left,y); ctx.stroke();
    ctx.fillText(`${c}`, left-28, y+4);
    ctx.strokeStyle=isLight? "rgba(60,90,130,0.06)" : "rgba(146,208,255,.04)";
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke();
    ctx.strokeStyle=isLight? "rgba(60,90,130,0.1)" : "rgba(146,208,255,0.08)";
  }

  // Fundo (elipse)
  ctx.beginPath();
  ctx.ellipse(W/2, top+height, width*0.47, 10, 0, 0, Math.PI*2);
  const base=ctx.createRadialGradient(W/2, top+height, 4, W/2, top+height, width*0.5);
  base.addColorStop(0,isLight?"rgba(0,0,0,0.2)":"rgba(0,0,0,0.5)");
  base.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=base; ctx.fill();

  ctx.restore();
}

function getTickColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--tick') || "#9cc7ff"; }

/* Esfera com shading */
function drawSphere3D(ctx, x, y, r, color, z){
  ctx.save();
  const s=ctx.createRadialGradient(x, y+r*0.9, r*0.1, x, y+r*0.9, r*1.6);
  s.addColorStop(0,"rgba(0,0,0,0.30)");
  s.addColorStop(1,"rgba(0,0,0,0)");
  ctx.globalAlpha = 0.55 * (0.4 + 0.6*z);
  ctx.fillStyle=s; ctx.beginPath(); ctx.ellipse(x, y+r*0.95, r*1.2, r*0.4, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;

  const base=ctx.createRadialGradient(x-r*0.35, y-r*0.35, r*0.2, x, y, r*1.05);
  base.addColorStop(0, "rgba(255,255,255,0.9)");
  base.addColorStop(0.15, color.replace("hsl","hsla").replace(")",",0.95)"));
  base.addColorStop(1, "rgba(10,10,20,0.5)");
  ctx.fillStyle=base; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

  const spec=ctx.createRadialGradient(x-r*0.45, y-r*0.48, 2, x-r*0.45, y-r*0.48, r*0.5);
  spec.addColorStop(0,"rgba(255,255,255,0.9)");
  spec.addColorStop(1,"rgba(255,255,255,0)");
  ctx.globalCompositeOperation="lighter";
  ctx.fillStyle=spec; ctx.beginPath(); ctx.arc(x-r*0.35,y-r*0.38,r*0.55,0,Math.PI*2); ctx.fill();

  const rim=ctx.createLinearGradient(x, y+r*0.2, x, y+r);
  rim.addColorStop(0,"rgba(255,255,255,0)");
  rim.addColorStop(1,"rgba(255,255,255,0.25)");
  ctx.globalCompositeOperation="screen";
  ctx.fillStyle=rim; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

  ctx.globalCompositeOperation="source-over";
  ctx.restore();
}

/* ===== Desenho + animaÃ§Ã£o ===== */
function drawScene(dtReal){
  const {ctx,canvas}=el; const W=canvas.width, H=canvas.height;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);

  const isLight = document.documentElement.getAttribute('data-theme')==="light";
  if(isLight){
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,W,H);
  }else{
    const bg=ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0,"rgba(10,20,40,0.4)"); bg.addColorStop(1,"rgba(5,10,20,0.8)");
    ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  }

  drawTank(ctx,W,H);

  const Hm=state.fluid.H_cm/100; const dt=dtReal*state.timeScale; state.tSim+=dt;
  const mu=muPaS();

  for(let i=0;i<state.particles.length;i++){
    const p=state.particles[i];
    p.v=vStokes_sphericity(p.d_m,p.rho_p,state.fluid.rho_f,mu,state.fluid.g,p.phi);
    p.Re=reynolds(state.fluid.rho_f,Math.abs(p.v),p.d_m,mu);
    if(!p.settled){
      const dy=Math.abs(p.v)*dt;
      if(p.v>=0){p.depth_m=Math.min(Hm,(p.depth_m??0)+dy);if(p.depth_m>=Hm){p.depth_m=Hm;p.settled=true;}}
      else{p.depth_m=Math.max(0,(p.depth_m??Hm)-dy);if(p.depth_m<=0){p.depth_m=0;p.settled=true;}}
    }
  }
  state.particles.sort((a,b)=>a.z-b.z);

  for(let i=0;i<state.particles.length;i++){
    const p=state.particles[i];
    const y=yFromDepth(p.depth_m||0);
    const rBase = clamp(p.d_um/3.2, 2, 10);
    const r = rBase*(0.6 + 0.8*p.z);
    drawSphere3D(ctx, p.x, y, r, p.color, p.z);
    if(state.selected===i){
      ctx.strokeStyle=isLight? "#c08400" : "#fbbf24"; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(p.x,y,r+3,0,Math.PI*2); ctx.stroke();
    }
  }
}

/* ===== InteraÃ§Ã£o com a coluna ===== */
document.getElementById('playPause').addEventListener('click',()=>{
  state.playing=!state.playing;
  document.getElementById('playPause').textContent=state.playing?"â¸ï¸ Pausar":"â–¶ï¸ Reproduzir";
});
document.getElementById('reset').addEventListener('click',()=>{
  const Hm=state.fluid.H_cm/100;
  state.particles.forEach(p=>{p.settled=false;p.depth_m=(p.v>=0?0:Hm)});
  state.tSim=0;
});
document.getElementById('exportCsv').addEventListener('click',()=>{
  const csv=state.csvRows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download="stokes_particulas.csv";document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
});
el.canvas.addEventListener('click',(ev)=>{
  const rect=el.canvas.getBoundingClientRect();
  const x=(ev.clientX-rect.left)*(el.canvas.width/rect.width);
  const y=(ev.clientY-rect.top)*(el.canvas.height/rect.height);
  let best=-1,bestD=1e12;
  for(let i=0;i<state.particles.length;i++){
    const p=state.particles[i];
    const r=clamp(p.d_um/3.2,2,10)*(0.6+0.8*p.z)+4;
    const py=yFromDepth(p.depth_m||0);
    const dx=p.x-x,dy=py-y,d2=dx*dx+dy*dy;
    if(d2<=r*r && d2<bestD){bestD=d2;best=i;}
  }
  if(best>=0){state.selected=best;updateSelectedIndicators();}
});

/* ===== SaÃ­da numÃ©rica (calculadora) ===== */
function calc_setCalcFieldsDisabled(){
  const on = (el.calc_useWaterT.value==="on");
  el.calc_rho_f.disabled = on;
  el.calc_mu_mpas.disabled = on;
}
function calc_applyWaterTIfRequested(){
  if(el.calc_useWaterT.value==="on"){
    const Tc = parseFloat(el.calc_T.value||"20");
    const rho = waterRho_fromT(Tc);
    const muPaS = waterMuPaS_fromT(Tc);
    el.calc_rho_f.value = rho.toFixed(1);
    el.calc_mu_mpas.value = (muPaS*1e3).toFixed(3);
  }
}
function syncCalcFromTop(){
  el.h_target_cm.value = (state.fluid.H_cm||50);
  el.calc_d_um.value = el.d_um.value;
  el.calc_phi.value = el.phi.value;
  el.calc_rho_p.value = el.rho_p.value;
  el.calc_rho_f.value = el.rho_f.value;
  el.calc_mu_mpas.value = el.mu_mpas.value;
  el.calc_g.value = el.g.value;
  el.calc_T.value = (state.fluid.T||20);
  el.calc_useWaterT.value = state.fluid.useWaterT ? "on" : "off";
  calc_setCalcFieldsDisabled();
  calc_applyWaterTIfRequested();
}
function calcOnce(){
  calc_applyWaterTIfRequested();

  const h_cm = Math.max(0.0001, parseFloat(el.h_target_cm.value||"50"));
  const d_um = Math.max(0.0001, parseFloat(el.calc_d_um.value||"100"));
  const phi = clamp(parseFloat(el.calc_phi.value||"1"), 0.1, 1);
  const rho_p = parseFloat(el.calc_rho_p.value||"2650");
  const rho_f = parseFloat(el.calc_rho_f.value||"997");
  const mu = Math.max(1e-9, parseFloat(el.calc_mu_mpas.value||"1")*1e-3); // PaÂ·s
  const g = parseFloat(el.calc_g.value||"9.81");
  const T_used = parseFloat(el.calc_T.value||"20");
  const useT = (el.calc_useWaterT.value==="on");

  const d_m = d_um*1e-6;
  const v = vStokes_sphericity(d_m, rho_p, rho_f, mu, g, phi); // m/s
  const Re = reynolds(rho_f, Math.abs(v), d_m, mu);
  const t_s = (h_cm/100) / Math.max(1e-12, Math.abs(v));
  const t_min = t_s/60;
  const dir = v>=0 ? "descida (Ïp > Ïf)" : "subida (Ïp < Ïf)";
  const regime = Re<0.1 ? "Stokes (laminar)" : (Re<1 ? "TransiÃ§Ã£o inicial" : "Fora de Stokes");

  el.out_v.textContent = fmt(v,6);
  el.out_Re.textContent = fmt(Re,4);
  el.out_t.textContent = fmt(t_s,3);
  el.out_t_min.textContent = fmt(t_min,3);
  el.out_t_hms.textContent = toHMS(t_s);
  el.out_dir.textContent = dir;
  el.out_regime.textContent = regime;
  el.out_T.textContent = fmt(T_used,1)+(useT?" (auto Ã¡gua)":"");

  const cls = Re<0.1 ? "good" : (Re<1 ? "warn" : "bad");
  el.out_Re.className = "pill "+cls;
  el.out_regime.className = "pill "+cls;

  return {h_cm,d_um,phi,rho_p,rho_f,mu,g,v,Re,t_s,t_min,dir,regime,T_used,useT};
}
['h_target_cm','calc_d_um','calc_phi','calc_rho_p','calc_rho_f','calc_mu_mpas','calc_g','calc_T','calc_useWaterT'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{ calc_setCalcFieldsDisabled(); calcOnce(); });
});
el.calcNow.addEventListener('click', calcOnce);
el.calcSyncFromTop.addEventListener('click', ()=>{ syncCalcFromTop(); calcOnce(); });
el.calcCopy.addEventListener('click', async ()=>{
  const r = calcOnce();
  const text = `Lei de Stokes â€” saÃ­da numÃ©rica:
h = ${r.h_cm} cm, d = ${r.d_um} Âµm, Ï† = ${r.phi}
Ïp = ${r.rho_p} kg/mÂ³, Ïf = ${r.rho_f} kg/mÂ³, Î¼ = ${(r.mu*1e3).toFixed(3)} mPaÂ·s, g = ${r.g} m/sÂ²
T = ${r.T_used} Â°C${r.useT?" (auto Ã¡gua)":""}
v = ${r.v.toExponential(6)} m/s, Re = ${r.Re.toExponential(4)}
t = ${r.t_s.toFixed(3)} s (${r.t_min.toFixed(3)} min; ${toHMS(r.t_s)}), direÃ§Ã£o = ${r.dir}, regime = ${r.regime}`;
  try{ await navigator.clipboard.writeText(text);}catch(e){}
});
el.calcCsv.addEventListener('click', ()=>{
  const r = calcOnce();
  const header = ["h_cm","d_um","phi","rho_p","rho_f","mu_Pa_s","g","T_C","use_T_water","v_ms","Re","t_s","t_min","t_hhmmss","direction","regime"];
  const row = [r.h_cm,r.d_um,r.phi,r.rho_p,r.rho_f,r.mu,r.g,r.T_used,r.useT,r.v,r.Re,r.t_s,r.t_min, toHMS(r.t_s), r.dir,r.regime];
  const csv=[header.join(","),row.join(",")].join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download="stokes_saida_numerica.csv";document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
});

/* ===== Loop de animaÃ§Ã£o ===== */
let lastT=performance.now();
function loop(now){
  const dt=(now-lastT)/1000; lastT=now;
  drawScene(state.playing?dt:0);
  requestAnimationFrame(loop);
}

/* ===== DPI/resize ===== */
function resizeDPI(c,ctx){
  const dpr=window.devicePixelRatio||1;
  const w=c.clientWidth,h=c.clientHeight;
  c.width=Math.round(w*dpr); c.height=Math.round(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

function init(){
  initTheme();
  applyPreset();
  // Lotes exemplo
  addBatch(); // lote padrÃ£o
  el.d_um.value="25"; el.n_particles.value="140"; el.phi.value="0.8"; addBatch();
  el.d_um.value="120"; el.n_particles.value="70"; el.phi.value="1.0";
  syncCalcFromTop(); calcOnce();

  new ResizeObserver(()=>{resizeDPI(el.canvas,el.ctx);}).observe(el.canvas);
  resizeDPI(el.canvas,el.ctx);

  lastT=performance.now(); requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>
